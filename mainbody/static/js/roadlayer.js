
let poly;
let map;
let points;
let marker;
let firstMarker;
let oldRoads = {};
let isLocationOnEdge;

const old_layer_points = {
    'Road 10':
        [
            { 'lat': 22.607726468744172, 'lng': 88.41365115943643 },
            { 'lat': 22.607065885896972, 'lng': 88.41137276638602 }
        ],
    'Road 11': [{
        'lat': 22.60811754233087,
        'lng': 88.41315598246234
    },
    {
        'lat': 22.607303186609798,
        'lng': 88.41047914816032
    },
    {
        'lat': 22.607018095308533,
        'lng': 88.40944704090724
    }],
    'Road 12': [{
        'lat': 22.608487877146125,
        'lng': 88.41267900734793
    },
    {
        'lat': 22.60743252514446,
        'lng': 88.40928982407202
    },
    {
        'lat': 22.607028031285502,
        'lng': 88.40796743606431
    }],
    'Road 13': [{
        'lat': 22.608777822853728,
        'lng': 88.41220537132232
    },
    {
        'lat': 22.60745709204454,
        'lng': 88.40768266352977
    }],
    'Road 14': [{
        'lat': 22.60924867464292,
        'lng': 88.41199522886684
    },
    {
        'lat': 22.609092225713688,
        'lng': 88.41188147222857
    },
    {
        'lat': 22.60867862739353,
        'lng': 88.41049101041185
    }],
    'Road 15': [{
        'lat': 22.608600142526388,
        'lng': 88.41008668018705
    },
    {
        'lat': 22.607807593533185,
        'lng': 88.40741276663796
    }],
    'Road 16': [{
        'lat': 22.609369455209894,
        'lng': 88.41124680839897
    },
    {
        'lat': 22.608750354285082,
        'lng': 88.40910131884073
    }],
    'Road 17': [{
        'lat': 22.60849718067895,
        'lng': 88.40818240024582
    },
    {
        'lat': 22.60825005101282,
        'lng': 88.40730515282308
    }],
    'Road 18': [{
        'lat': 22.60835816290208,
        'lng': 88.40903813389023
    },
    {
        'lat': 22.608607380908854,
        'lng': 88.40740699758705
    }],
    'Road 19': [{
        'lat': 22.61007552859956,
        'lng': 88.41025785988992
    },
    {
        'lat': 22.6098325496145,
        'lng': 88.40963868681618
    }],
    'Road 2': [{
        'lat': 22.603241811960178,
        'lng': 88.41217493966121
    },
    {
        'lat': 22.603306227157937,
        'lng': 88.41201973285791
    },
    {
        'lat': 22.603750882840533,
        'lng': 88.41188388876456
    },
    {
        'lat': 22.60389770107273,
        'lng': 88.41181935300438
    },
    {
        'lat': 22.604307301761168,
        'lng': 88.4116649281635
    },
    {
        'lat': 22.604714058424385,
        'lng': 88.41150475552774
    },
    {
        'lat': 22.60516262663288,
        'lng': 88.4113713845921
    },
    {
        'lat': 22.605612651391855,
        'lng': 88.41121235025767
    },
    {
        'lat': 22.606091942668723,
        'lng': 88.41103968836264
    },
    {
        'lat': 22.60644515110796,
        'lng': 88.4108910256587
    },
    {
        'lat': 22.606899478918923,
        'lng': 88.41072846510853
    },
    {
        'lat': 22.60732979414972,
        'lng': 88.41056473111237
    },
    {
        'lat': 22.60773675407925,
        'lng': 88.41038894827092
    },
    {
        'lat': 22.60818276866182,
        'lng': 88.4102205392651
    },
    {
        'lat': 22.608595649498277,
        'lng': 88.41008525981024
    },
    {
        'lat': 22.609387000797216,
        'lng': 88.40981055992586
    },
    {
        'lat': 22.609836832933226,
        'lng': 88.40964215086107
    },
    {
        'lat': 22.610222109746815,
        'lng': 88.40949317043162
    },
    {
        'lat': 22.610516788463634,
        'lng': 88.4093747713901
    },
    {
        'lat': 22.61075896023845,
        'lng': 88.4093353050038
    },
    {
        'lat': 22.611132932670472,
        'lng': 88.40934923433473
    }],
    'Road 20': [{
        'lat': 22.610384712563377,
        'lng': 88.40996548388522
    },
    {
        'lat': 22.610322548898132,
        'lng': 88.40981495904059
    },
    {
        'lat': 22.610218333231973,
        'lng': 88.40950598780461
    }],
    'Road 21': [{
        'lat': 22.608974824488744,
        'lng': 88.40876420892266
    },
    {
        'lat': 22.609191284944462,
        'lng': 88.40755397072341
    }],
    'Road 22': [{
        'lat': 22.609337821113538,
        'lng': 88.40881790456733
    },
    {
        'lat': 22.609418674619306,
        'lng': 88.4084629580328
    }],
    'Road 23': [{
        'lat': 22.609040711540686,
        'lng': 88.40835704597916
    },
    {
        'lat': 22.610095189315167,
        'lng': 88.40862140497566
    },
    {
        'lat': 22.61097766133273,
        'lng': 88.40874724951901
    },
    {
        'lat': 22.61107229754053,
        'lng': 88.40875386371464
    }],
    'Road 24': [{
        'lat': 22.60374486322682,
        'lng': 88.41187290343915
    },
    {
        'lat': 22.602533585141288,
        'lng': 88.41006496442185
    },
    {
        'lat': 22.60236660132205,
        'lng': 88.40963104880193
    },
    {
        'lat': 22.60182781337594,
        'lng': 88.40866607938915
    },
    {
        'lat': 22.601427114177284,
        'lng': 88.40801195106751
    },
    {
        'lat': 22.6008303340991,
        'lng': 88.40703229382608
    },
    {
        'lat': 22.600457589606588,
        'lng': 88.40649098948995
    }],
    'Road 25': [{
        'lat': 22.60390133565761,
        'lng': 88.41181193706944
    },
    {
        'lat': 22.60348729305863,
        'lng': 88.40936264431286
    }],
    'Road 26': [{
        'lat': 22.60470989944136,
        'lng': 88.41149643251622
    },
    {
        'lat': 22.60457192352139,
        'lng': 88.41072066051373
    },
    {
        'lat': 22.604380335433074,
        'lng': 88.41007846898862
    },
    {
        'lat': 22.604142899757946,
        'lng': 88.40913744646389
    }],
    'Road 27': [{
        'lat': 22.605157590134286,
        'lng': 88.4113619965941
    },
    {
        'lat': 22.604796953776432,
        'lng': 88.41002326681773
    },
    {
        'lat': 22.60453065541522,
        'lng': 88.4090769156253
    }],
    'Road 28': [{
        'lat': 22.605153024150468,
        'lng': 88.41136392936596
    },
    {
        'lat': 22.604541743491218,
        'lng': 88.40907222047232
    }],
    'Road 29': [{
        'lat': 22.603170751873627,
        'lng': 88.41099375159406
    },
    {
        'lat': 22.604574926563956,
        'lng': 88.4107146460715
    }],
    'Road 3': [{
        'lat': 88.4093747713901,
        'lng': 22.61075896023845
    },
    {
        'lat': 22.61107078259098,
        'lng': 88.40914029479814
    },
    {
        'lat': 22.611162936195722,
        'lng': 88.40911707931487
    }],
    'Road 30': [{
        'lat': 22.60275415998655,
        'lng': 88.41038397262925
    },
    {
        'lat': 22.604385507954238,
        'lng': 88.41007847974912
    },
    {
        'lat': 22.604782369474435,
        'lng': 88.41001578061169
    },
    {
        'lat': 22.605216719162097,
        'lng': 88.40990763599142
    }],
    'Road 31': [{
        'lat': 22.60527539229795,
        'lng': 88.4100751036918
    },
    {
        'lat': 22.60575778062972,
        'lng': 88.40989610144116
    },
    {
        'lat': 22.606108471648117,
        'lng': 88.40976879189947
    },
    {
        'lat': 22.606563613248795,
        'lng': 88.40962119358176
    },
    {
        'lat': 22.607418356536073,
        'lng': 88.40929189655871
    },
    {
        'lat': 22.607852040651107,
        'lng': 88.40912218482555
    },
    {
        'lat': 22.608274370398338,
        'lng': 88.4090508566738
    },
    {
        'lat': 22.60835273567947,
        'lng': 88.40905382955911
    },
    {
        'lat': 22.60857111990955,
        'lng': 88.40905017788295
    },
    {
        'lat': 22.61043866803041,
        'lng': 88.40931841447976
    },
    {
        'lat': 22.610529827204456,
        'lng': 88.40936629296648
    }],
    'Road 32': [{
        'lat': 22.60236891778213,
        'lng': 88.40964170688281
    },
    {
        'lat': 22.603034331512387,
        'lng': 88.4094661044927
    },
    {
        'lat': 22.603487395441356,
        'lng': 88.40936548961467
    },
    {
        'lat': 22.60385403197375,
        'lng': 88.40921748547383
    },
    {
        'lat': 22.604136729006,
        'lng': 88.40913631855759
    },
    {
        'lat': 22.60424685577013,
        'lng': 88.4090883564815
    },
    {
        'lat': 22.604699275798446,
        'lng': 88.40905280942557
    },
    {
        'lat': 22.605443041052105,
        'lng': 88.40892127417288
    },
    {
        'lat': 22.605449555964064,
        'lng': 88.40891774517611
    },
    {
        'lat': 22.606154666219084,
        'lng': 88.40804902123027
    },
    {
        'lat': 22.606241864768368,
        'lng': 88.40800608684133
    },
    {
        'lat': 22.606296033559236,
        'lng': 88.40802970078899
    },
    {
        'lat': 22.606345578178445,
        'lng': 88.4080790754332
    },
    {
        'lat': 22.60652592269015,
        'lng': 88.40828416011563
    },
    {
        'lat': 22.60663871180769,
        'lng': 88.40832933475481
    },
    {
        'lat': 22.606681363188702,
        'lng': 88.40831701449115
    },
    {
        'lat': 22.60676287474894,
        'lng': 88.4082543862464
    },
    {
        'lat': 22.60703256186227,
        'lng': 88.40795751642425
    },
    {
        'lat': 22.607821351239263,
        'lng': 88.40739947861393
    },
    {
        'lat': 22.608084214535783,
        'lng': 88.4072720587657
    },
    {
        'lat': 22.608232501315154,
        'lng': 88.40728685417628
    },
    {
        'lat': 22.60860516945599,
        'lng': 88.40740098819009
    }],
    'Road 4': [{
        'lat': 22.60412283324279,
        'lng': 88.41642246733561
    },
    {
        'lat': 22.604296920052857,
        'lng': 88.41466363362989
    },
    {
        'lat': 22.60503439477717,
        'lng': 88.41402249563409
    },
    {
        'lat': 22.60529710197711,
        'lng': 88.41376192961283
    },
    {
        'lat': 22.605661092804528,
        'lng': 88.4133505082569
    },
    {
        'lat': 22.606091549907806,
        'lng': 88.41299737037109
    },
    {
        'lat': 22.606550487901053,
        'lng': 88.41278137014525
    },
    {
        'lat': 22.607335431728103,
        'lng': 88.41227738008266
    },
    {
        'lat': 22.607708912448416,
        'lng': 88.41183509907553
    },
    {
        'lat': 22.608028583700662,
        'lng': 88.41136539169102
    },
    {
        'lat': 22.608383069430683,
        'lng': 88.41094025452885
    },
    {
        'lat': 22.608971770451717,
        'lng': 88.41011054862324
    },
    {
        'lat': 22.60899392583747,
        'lng': 88.41008997726209
    }],
    'Road 5': [{
        'lat': 22.60563870107325,
        'lng': 88.41495711525918
    },
    {
        'lat': 22.604663727830648,
        'lng': 88.41153579319588
    }],
    'Road 6': [{
        'lat': 22.606048532633178,
        'lng': 88.41463943937175
    },
    {
        'lat': 22.605105770730045,
        'lng': 88.41139926293796
    }],
    'Road 7': [{
        'lat': 22.60650842365769,
        'lng': 88.41442859479085
    },
    {
        'lat': 22.60559667032866,
        'lng': 88.41122147431915
    },
    {
        'lat': 22.604986314587585,
        'lng': 88.40899351153486
    }],
    'Road 8': [{
        'lat': 22.60699633013267,
        'lng': 88.41441126285407
    },
    {
        'lat': 22.606094680286454,
        'lng': 88.41103510013922
    },
    {
        'lat': 22.605437074786792,
        'lng': 88.40892359080844
    }],
    'Road 9': [{
        'lat': 22.607401379420104,
        'lng': 88.41414258831911
    },
    {
        'lat': 22.606116209413685,
        'lng': 88.4097697024602
    },
    {
        'lat': 22.605812952049757,
        'lng': 88.40850481158616
    }],
    'Road1': [{
        'lat': 22.60311976587206,
        'lng': 88.41875486379743
    },
    {
        'lat': 22.60451636873204,
        'lng': 88.41738849548747
    },
    {
        'lat': 22.607118116850764,
        'lng': 88.41505571876415
    },
    {
        'lat': 22.607453614924907,
        'lng': 88.41469572304007
    },
    {
        'lat': 22.60817929424606,
        'lng': 88.41366911248208
    },
    {
        'lat': 22.60924095662108,
        'lng': 88.41199752115492
    },
    {
        'lat': 22.61118467871619,
        'lng': 88.40951283916522
    },
    {
        'lat': 22.61127841700577,
        'lng': 88.40946916451666
    }]
}


function initMap() {
    isLocationOnEdge = google.maps.geometry.poly.isLocationOnEdge
    map = new google.maps.Map(document.getElementById("RouteMap"), {
        zoom: 17,
        //center: { lat: 22.598576940415658, lng: 88.40287426753889 },
        center: { lat: 22.60719525900128, lng: 88.41133619141767 },
    });
    poly = new google.maps.Polyline({
        strokeColor: "#000000",
        strokeOpacity: 0.80,
        strokeWeight: 5,
    });

    poly.setMap(map);
    
    savedPoints.forEach(value =>{
        const latLng=new google.maps.LatLng({lat: parseFloat(value.lat), lng: parseFloat(value.lng)});
        poly.getPath().push(latLng);
    })

    // Plot old roads
    for (const [road, points] of Object.entries(old_layer_points)) {
        const path = new google.maps.Polyline({
            path: points,
            strokeColor: "#0000FF",
            strokeOpacity: 1.0,
            strokeWeight: 5,
            clickable: true,
            new google.maps.LatLng(    zindex: 0,
        });
        path.setMap(map);
        path.onPath=true
        path.addListener('click', addLatLng)
        path.setVisible(true);
        oldRoads[road] = path;
    }
    // Add a listener for the click event
    map.addListener("click", addLatLng);
}

// Handles click events on a map, and adds a new point to the Polyline.
function addLatLng(event) {
    const path = poly.getPath();
    let onRoad = false;

    for (const [name, road] of Object.entries(oldRoads)) {
        onRoad = false
        // Because path is an MVCArray, we can simply append a new coordinate
        // and it will automatically appear.

        if (road.onPath || isLocationOnEdge(event.latLng, road)) {
            onRoad = true
        } else {
            onRoad = false
        }
    }
    
        path.push(event.latLng);
        // Add a new marker at the new plotted point on the polyline.
        if (firstMarker) {
            if (marker) {
                marker.setMap(null);
            }
            marker = new google.maps.Marker({
                position: event.latLng,
                title: "#" + path.getLength(),
                map: map,
            });
        } else {
            firstMarker = new google.maps.Marker({
                position: event.latLng,
                title: "#" + path.getLength(),
                map: map,
            })
        }

        function getCookie(key) {
            var cookies = document.cookie;
            var value = cookies.split(key + '=');
            if (value.length > 1) {
                return value[1].split(';')[0]
        
            }
        }

        console.log(event.latLng.lat(), event.latLng.lng())

        ajaxfunction(event.latLng.lat(), event.latLng.lng());
        
        function ajaxfunction(lat,lng){
            $.ajax({
              type: "POST",
              url: "/draw",
              data: {
                lat: lat,
                lng:lng,
                csrfmiddlewaretoken: getCookie('csrftoken')
              },
              success: (response) => {
                if (response.status == 'OK') console.log('frv journey started')
              }
              });
        }
    // }
}
//        JSON.stringify(mapsMouseEvent.latLng.toJSON(), null, 2)


window.initMap = initMap;
