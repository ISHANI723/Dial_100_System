const coordinates = {
    hospital: {
        "Ohio Hospital": {
            "lat": 22.578305383029246,
            "lng": 88.47703737631674
        },
        "Bhagirathi Neotia Woman and Child Care Centre": {
            "lat": 22.54775761354874,
            "lng": 88.35943218142147
        },
        "Tata Medical Center": {
            "lat": 22.577345819082442,
            "lng": 88.4796226567554
        },
        "Echo Hospital": {
            "lat": 22.58094905782243,
            "lng": 88.47762705703762
        },
        "Charnock Hospital": {
            "lat": 22.625906232699847,
            "lng": 88.43440450676506
        },
        "NABODIGANTA HEALTH CARE": {
            "lat": 22.579578854540397,
            "lng": 88.47585006802154
        },
        "Ujjiiban Multi Specialty Hospital": {
            "lat": 22.585290002394924,
            "lng": 88.47216790724714
        },
        "Reckjoani Rural Hospital": {
            "lat": 22.62605292992326,
            "lng": 88.47810676570283
        },
        "Belle Vue Hospital": {
            "lat": 22.583829204305538,
            "lng": 88.49280502294074
        },
        "Patharghata Primary Health Center": {
            "lat": 22.568462465960224,
            "lng": 88.50275444577035
        },
        "Govt.of West Bengal Reckjoani Rural Hospital": {
            "lat": 22.62606475639054,
            "lng": 88.47796498648941
        },
        "Sankara Nethralaya New Town": {
            "lat": 22.573946009920263,
            "lng": 88.4794711125181
        },
        "HCG EKO Cancer Centre Kolkata": {
            "lat": 22.579851758371063,
            "lng": 88.47750157284537
        },
        "RAVI DENTAL HOSPITAL NEW TOWN": {
            "lat": 22.576546586358035,
            "lng": 88.47962635478798
        },
        "Chittaranjan National Cancer Institute": {
            "lat": 22.567504541590584,
            "lng": 88.46901626151582
        },
        "Vinod Neotia Covid Care Centre": {
            "lat": 22.580035268821835,
            "lng": 88.47516665488624
        },
        "W B GOVT.HEALTH CENTER": {
            "lat": 22.580746868677817,
            "lng": 88.48009299044854
        },
        "Glocal Healthcare Systems Private Limited": {
            "lat": 22.585600173374743,
            "lng": 88.49139158384224
        },
        "Lotus Hospital": {
            "lat": 22.635039503760456,
            "lng": 88.47857409040918
        },
        "Rajarhat apex hospital pvt ltd": {
            "lat": 22.614321312124773,
            "lng": 88.5105116193641
        },
        "Transparance Site Mother & Child Care Hospital": {
            "lat": 22.593893796974626,
            "lng": 88.46767860692115
        },
        "Manipal Hospital": {
            "lat": 22.572379017209656,
            "lng": 88.4128174015032
        },
        "Parkview Super Speciality Hospital": {
            "lat": 22.57523935651491,
            "lng": 88.4172371725103
        },
        "Spandan Hospital": {
            "lat": 22.62073899950217,
            "lng": 88.43288204790757
        },
        "Daffodil Hospital (Multi-speciality Hospital)": {
            "lat": 22.601949378199272,
            "lng": 88.40468872320001
        },
        "Ruby": {
            "lat": 22.598576940415658,
            "lng": 88.40287426753889
        },
        "Calcutta Heart Clinic & Hospital": {
            "lat": 22.575701407068895,
            "lng": 88.41822809214528
        },
        "Fortis Hospital": {
            "lat": 22.52211021458458,
            "lng": 88.40085607249912
        },
        "Apollo Multispeciality Hospitals": {
            "lat": 22.574892642458074,
            "lng": 88.40038100397197
        },
        "Apollo Clinic Newtown": {
            "lat": 22.58231735421091,
            "lng": 88.46069990028052
        },
        "Uma Medical and Jahar test tube Baby Center": {
            "lat": 22.623246835630717,
            "lng": 88.43312173518933
        },
        "Woodlands Multispeciality Hospital Private Limited": {
            "lat": 22.533167124549518,
            "lng": 88.32878311702923
        },
        "DARADIA: The Pain Clinic": {
            "lat": 22.57986721665231,
            "lng": 88.47676210340006
        },
        "Bhagirathi Neotia Womens and Child Hospital": {
            "lat": 22.58582863696292,
            "lng": 88.46419035318523
        },
        "Peerless Hospital": {
            "lat": 22.483573627583187,
            "lng": 88.39465203952379
        },
        "ARIYAN HOSPITAL MULTISPECIALITY": {
            "lat": 22.622450911213132,
            "lng": 88.44584575220665
        },
        "IRIS MULTISPECIALITY HOSPITAL": {
            "lat": 22.480187104710996,
            "lng": 88.37651782941096
        }
    },
    policeStation: {
        "New Town Police Station": {
            "lat": 22.581251276097326,
            "lng": 88.47851715103796
        },
        "Technocity Police Station": {
            "lat": 22.564871517979633,
            "lng": 88.51563870949663
        },
        "Rajarhat Police Station": {
            "lat": 22.634414216792273,
            "lng": 88.48489577388378
        },
        "ACP & DCP Office Bidhannagar": {
            "lat": 22.588575183209247,
            "lng": 88.45192048269172
        },
        "Bidhannagar East Police Station": {
            "lat": 22.59080236743551,
            "lng": 88.43221332772964
        },
        "Bidhannagar North Police Station": {
            "lat": 22.597396782022265,
            "lng": 88.4166966209827
        },
        "Lake Town Police Station": {
            "lat": 22.61117906069684,
            "lng": 88.40472567767054
        },
        "Eco Park Police Station": {
            "lat": 22.601855980715946,
            "lng": 88.46760267353899
        },
        "Bidhannagar Traffic Control Room": {
            "lat": 22.594565827405898,
            "lng": 88.45455641006129
        },
        "Bidhannagar South Police Station": {
            "lat": 22.577131286996803,
            "lng": 88.4133576832896
        },
        "Cyber Crime Police Station": {
            "lat": 22.59998720475525,
            "lng": 88.4150556252278
        },
        "Baguiati Police Station": {
            "lat": 22.631495492648543,
            "lng": 88.42615911604467
        },
        "West Bengal Police Booth": {
            "lat": 22.58479991107176,
            "lng": 88.41299942322466
        },
        "Electronics Complex Police Station": {
            "lat": 22.58479991107176,
            "lng": 88.43068276045157
        },
        "Kolkata Traffic Police": {
            "lat": 22.594671842513403,
            "lng": 88.42204671203844
        },
        "Bidhannagar Police Commissionerate": {
            "lat": 22.57796508250475,
            "lng": 88.41176570202278
        },
        "Bidhannagar women police station": {
            "lat": 22.587837503809205,
            "lng": 88.42615911604467
        },
        "Chinarpark Traffic Guard Office": {
            "lat": 22.631115917688863,
            "lng": 88.44096377046722
        }
    },
    fireStation: {
        "Newtown - Rajarhat Fire Station": {
            "lat": 22.579783567356824,
            "lng": 88.45847724147374
        },
        "Fire Brigade Sector 5": {
            "lat": 22.56926551832623,
            "lng": 88.43222217838807
        },
        "Alifnagar Fire Station": {
            "lat": 22.539763591802057,
            "lng": 88.29476799026997
        },
        "Fire Brigade Headquarters": {
            "lat": 22.558923209212168,
            "lng": 88.35506386342387
        },
        "Gariahat Fire Station": {
            "lat": 22.518572045598113,
            "lng": 88.36447007354717
        },
        "Behala Fire Station": {
            "lat": 22.475126880831546,
            "lng": 88.3115988428258
        },
        "Baishnabghata - Patuli Fire Station": {
            "lat": 22.47257471261528,
            "lng": 88.3904687420294
        },
        "Sub Fire Station": {
            "lat": 22.6603508797781,
            "lng": 88.44162143258772
        },
        "Calcutta Fire Brigade": {
            "lat": 22.57852080736447,
            "lng": 88.3605983011075
        },
        "Kalighat Fire Station": {
            "lat": 22.52421859186343,
            "lng": 88.34347124339617
        },
        "Budge Budge Fire Station": {
            "lat": 22.490787282354574,
            "lng": 88.1888272772061
        },
        "West Bengal Fire & Emergency Services": {
            "lat": 22.558776465299058,
            "lng": 88.35472003829192
        },
        "Manicktala Fire Station": {
            "lat": 22.584308779563138,
            "lng": 88.39169524895293
        },
        "Kamarhati Fire Station": {
            "lat": 22.68463109357093,
            "lng": 88.37421861285831
        },
        "Bally Fire Station": {
            "lat": 22.649851067064024,
            "lng": 88.35078620314839
        },
        "Belur Fire Brigade": {
            "lat": 22.628434290974567,
            "lng": 88.3509005618813
        },
        "CANNING FIRE STATION": {
            "lat": 22.32208344606992,
            "lng": 88.65300897514696
        }
    },
}

const polygoan = {
    bhopal: {
        tourist_spots: {
            'Birla Museum': [
                { lat: 23.237747463068203, lng: 77.40815544723407 },
                { lat: 23.237790593847897, lng: 77.40825871228056 },
                { lat: 23.237814623847687, lng: 77.40825871228056 },
                { lat: 23.237743149989473, lng: 77.40821311472756 },
                { lat: 23.237747463068203, lng: 77.40815544723407 }
            ],
            'Van Vihar National Park Bhopal': [
                { lat: 23.232148376852145, lng: 77.36642308282013 },
                { lat: 23.2323363116034, lng: 77.36666381107787 },
                { lat: 23.23219705505902, lng: 77.36666381107787 },
                { lat: 23.232116951671195, lng: 77.36652835952339 },
                { lat: 23.232148376852145, lng: 77.36642308282013 }
            ],
            'Tekri-Bhopal View Point': [
                { lat: 23.281783375534353, lng: 77.36481943644397 },
                { lat: 23.281905333692617, lng: 77.36477249778646 },
                { lat: 23.282012508951603, lng: 77.36477249778646 },
                { lat: 23.281862217184774, lng: 77.36492940701297 },
                { lat: 23.281783375534353, lng: 77.36481943644397 }
            ],
            'Bharat Bhavan': [
                { lat: 23.24676025706354, lng: 77.39177632694923 },
                { lat: 23.246977128476928, lng: 77.39241066937771 },
                { lat: 23.246597603272086, lng: 77.39241066937771 },
                { lat: 23.246457129383476, lng: 77.39224169021071 },
                { lat: 23.246443574877635, lng: 77.39194798832521 }
            ],
            'Manuabhan Tekri': [
                { lat: 23.283157233017363, lng: 77.36397525459363 },
                { lat: 23.283344479928875, lng: 77.36420190125412 },
                { lat: 23.283332161061214, lng: 77.36420190125412 },
                { lat: 23.283146146020922, lng: 77.36419251352262 },
                { lat: 23.283157233017363, lng: 77.36397525459363 }
            ]
        }

    },
    kolkata: {}
}

let polygoanMarkers = {
    bhopal: {
        tourist_spots: []
    },
    kolkata: {}
}

let kolkataMarkers = {
    hospital: [],
    policeStation: [],
    fireStation: [],
}

logos = {
    hospital: "hospital.png",
    policeStation: "policeStation.png",
    fireStation: "fireStation.png",
}

var googleMaps;
var MainMap;
var directionsService;
var directionsRenderer;
var distanceMatrixService;
var geocoder;

// Initialize and add the map
function initMap() {

    googleMaps = google.maps;

    // Kolkata (22.5726, 88.3639)
    // New Town, Kolkata (22.598576940415658, 88.40287426753889)
    const center = { lat: 22.598576940415658, lng: 88.40287426753889 };
    // The map, centered at center
    MainMap = new googleMaps.Map(document.getElementById("map"), {
        zoom: 12,
        center: center,
        streetViewControl: false,
        scaleControl: true,
        mapId: '5c2352b8c2a4449a',
    });

    geocoder = new google.maps.Geocoder();
    distanceMatrixService = new google.maps.DistanceMatrixService();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        draggable: true,
        map: MainMap,
        optimizeWaypoints: true,
        suppressMarkers: true
    })

    directionsRenderer.addListener("directions_changed", () => {
        const directions = directionsRenderer.getDirections();
    });

    // Plot the markers
    for (const [key, value] of Object.entries(coordinates)) {
        for (const [name, latLng] of Object.entries(value)) {
            const marker = new google.maps.Marker({
                position: latLng,
                map: MainMap,
                //label: name,
                title: name,
                icon: {
                    url: '/static/images/' + key + '.png',
                    scaledSize: {
                        height: 20,
                        width: 20,
                    },
                }
            });
            kolkataMarkers[key].push(marker)
        }
    }

    //plot the polygoans
    for (let region in polygoan) {
        for (let spot in polygoan[region]) {
            for (let place in polygoan[region][spot]) {
                const polygoanMarker = new google.maps.Polygon({
                    paths: polygoan[region][spot][place],
                    strokeColor: "#FF0000",
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    fillColor: "#FF0000",
                    fillOpacity: 0.35,
                    map: MainMap,
                });

                polygoanMarkers[region][spot][place] = polygoanMarker
            }
        }
    }
}

function displayRoute(origin, destination, service, display) {
    service
        .route({
            origin: origin,
            destination: destination,
            travelMode: google.maps.TravelMode.DRIVING,
        })
        .then((result) => {
            display.setDirections(result);
        })
        .catch((e) => {
            alert("Could not display directions due to: " + e);
            console.log("Could not display directions due to: " + e);
        });
}
// Sets the map on all markers in the array.
function setVisibilityOfAll(visibility, arr, label = '') {
    for (let i = 0; i < arr.length; i++) {
        arr[i].setVisible(visibility);
        arr[i].setLabel(label);
    }
}

// Removes the markers from the map, but keeps them in the array.
function hideMarker(element, type) {
    setVisibilityOfAll(element.checked, kolkataMarkers[type]);
}

function changeCheckboxValue(elementId, value) {
    getElementById(elementId).checked = value;
}

let DistanceMatrixResult = { hospital: '', fireStation: '', policeStation: '' }
let directionRouteService = {}
var IncidentMarker;

function distanceMatrix(element, case_id, frvType) {

    const button = $("#ShowOnMap_" + case_id);
    const lat = button.attr("lat");
    const lng = button.attr("lng");
    var incidentLocation;
    if (lat && lng) {
        incidentLocation = { lat: parseFloat(lat), lng: parseFloat(lng) }
        MainMap.setCenter(incidentLocation)
        if (IncidentMarker) IncidentMarker.setMap(null)
        IncidentMarker = new google.maps.Marker({
            position: incidentLocation,
            map: MainMap,
            //label: place[0],
            title: "Incident Location",
        });

    } else {
        button.trigger('click')
    }
    // Display only requested frv on the map
    Object.keys(kolkataMarkers).forEach(value => {
        if (value != frvType) {
            setVisibilityOfAll(false, kolkataMarkers[value]);
            document.getElementById(value + 'Toggle').checked = false
        } else {
            setVisibilityOfAll(true, kolkataMarkers[value]);
            document.getElementById(value + 'Toggle').checked = true;
        }
    })
    /*
        TODO: Call all distance matrix api and set the timings as labels
        Problem: distance matrix api only allows max 25 origns and destinations each
        Solution: 1) filter out trauma centres and emergency medical centres
                     (can be done region wise also)
                  2) do multiple request of 25 locations in each batch
    */

    // Going with 2nd approach

    // max no of origins/destinations for the distanceMatrix API
    const max = 25

    let locations = Object.values(coordinates[frvType]);
    let len = locations.length
    let location_index = 0;
    while (location_index < len) {
        let locationArr = locations.slice(location_index, location_index + max)
        distanceMatrixService.getDistanceMatrix({
            origins: locationArr,
            destinations: [incidentLocation],
            travelMode: 'DRIVING',
            drivingOptions: {
                // for the time 1 min (60000 milliseconds) from now.
                departureTime: new Date(Date.now() + 60000),
                trafficModel: 'bestguess'
            }
        }, callback.bind(null, location_index, frvType))
        location_index += max
    }

    function callback(index, frv_type, response, status) {
        if (status == 'OK') {
            var origins = response.originAddresses;

            for (var i = 0; i < origins.length; i++) {
                var element = response.rows[i].elements[0];
                var from = origins[i];
                if (element.status == 'OK') {
                    DistanceMatrixResult[frv_type][index + i] = {
                        distance: element.distance.text,
                        duration: element.duration.text,
                        duration_in_traffic: element.duration_in_traffic?.text
                    }
                    const marker = kolkataMarkers[frv_type][index + i];
                    const title = Object.keys(coordinates[frv_type])[index + i]
                    marker.setLabel(`${element.distance.text}, ${element.duration_in_traffic ? element.duration_in_traffic.text : element.duration.text}`);
                    marker.setClickable(true);
                    marker.setTitle(`${title} \n ${element.distance.text}, ${element.duration_in_traffic ? element.duration_in_traffic.text : element.duration.text}`)
                    googleMaps.event.clearListeners(marker, 'click');
                    marker.addListener('click', (event) => {
                        displayRoute(
                            event.latLng,
                            incidentLocation,
                            directionsService,
                            directionsRenderer
                        );
                    })

                    const contentString = `
                        <div id="content">
                            <div id="siteNotice"></div>
                            <h5 id="firstHeading" class="firstHeading">${title}</h5>
                            <div id="bodyContent">
                                <p><strong>${element.distance.text}, ${element.duration_in_traffic ? element.duration_in_traffic.text : element.duration.text}</strong></p>
                                <button type="button" class="btn btn-success" onclick="assignFRV(${incidentLocation.lat}, ${incidentLocation.lng}, '${title}', ${case_id})">Assign FRV</button>
                            </div>
                        </div>
                      `

                    const infowindow = new google.maps.InfoWindow({
                        content: contentString,
                    });

                    googleMaps.event.clearListeners(marker, 'contextmenu');
                    marker.addListener('contextmenu', (event) => {
                        infowindow.open({
                            anchor: marker,
                            map: MainMap,
                            shouldFocus: false,
                        });
                    });

                } else {
                    kolkataMarkers[frv_type][index + i].setVisible(false);
                    let error = element.status;
                    console.log(error);
                    DistanceMatrixResult[index + i] = {};
                }
            }
        } else {
            alert("Could not fetch results due to: " + status)
            console.log("Could not fetch results due to: " + status)
        }
    }
}


// Set "null" to ""
$("button[id^='ShowOnMap']").each(function () {
    let btn = $(this);
    const lat = btn.attr('lat');
    if (!lat || lat == "null") {
        btn.attr({ lat: "", lng: "" });
        btn.text('Set Location');
    } else {
        btn.attr('data-bs-toggle', '');
    }
})


// Helper function to make ajax calls
function ajaxCall(url, type, data, success, error = null) {
    $.ajax(
        {
            type: type,
            url: url,
            data: data,
            success: success,
            error: error
        })
}


function assignFRV(lat, lng, frvName, case_id) {
    ajaxCall(
        '/assignfrv',
        'POST',
        {
            lat: lat,
            lng: lng,
            frv_name: frvName,
            case_id: case_id,
            csrfmiddlewaretoken: getCookie('csrftoken')
        },
        response => {
            if (response.status == 'OK') {
                alert('FRV assigned successfully')
            } else {
                alert(`FRV assignment failed due to: ${response.status}`)
            }
        }
    )
}

function buildSetLocationMap(case_id, address = '') {

    $('#SetLocationBtn').attr({ lat: '', lng: '', case_id: case_id })

    const CaseLocationMap = new googleMaps.Map(document.getElementById("CaseLocationMap"), {
        zoom: 14,
        // center the map at kolkata
        center: { lat: 22.5726, lng: 88.3639 },
        streetViewControl: false,
        scaleControl: true,
        styles: [
            {
                featureType: "poi.business",
                stylers: [{ visibility: "off" }],
            },
            {
                featureType: "transit",
                elementType: "labels.icon",
                stylers: [{ visibility: "off" }],
            },
        ]
    });

    const CaseLocationMarker = new googleMaps.Marker({
        position: { lat: 22.5726, lng: 88.3639 },
        map: CaseLocationMap,
        title: "Drag this marker to accurate location",
        draggable: true,

    })

    CaseLocationMarker.addListener('dragend', event => {
        $('#SetLocationBtn').attr({ lat: event.latLng.lat(), lng: event.latLng.lng() })
    })

    if (address) codeAddress(address)

    function codeAddress(address) {
        geocoder.geocode({
            'address': address,
            componentRestrictions: {
                country: 'IN',
                //postalCode: '411001'
            },
            region: 'IN',
        }, function (results, status) {
            let lists = $('#gecodedMapLocations');
            let htmlContent = ``;
            if (status == 'OK') {
                var len = results.length
                for (var i = 0; i < len; i++) {
                    htmlContent += `
                    <div class="card border-dark mb-3 case-location" lat="${results[i].geometry.location.lat()}" lng="${results[i].geometry.location.lng()}">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item bg-light">Address: ${results[i].formatted_address}</li>
                            <li class="list-group-item bg-light">Location: ${results[i].geometry.location}</li>
                        </ul>
                    </div>
                    `
                }
                CaseLocationMap.setCenter(results[0].geometry.location);
                CaseLocationMarker.setPosition(results[0].geometry.location)
                lists.html(htmlContent)
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
                lists.html(htmlContent)
            }
            $('.case-location').click((e) => {
                let card = $(e.currentTarget);
                var lat = parseFloat(card.attr("lat"));
                var lng = parseFloat(card.attr("lng"));
                CaseLocationMap.setCenter({ lat: lat, lng: lng });
                CaseLocationMarker.setPosition({ lat: lat, lng: lng })
                $('#SetLocationBtn').attr({ lat: lat, lng: lng })

            })
        });
    }

    $('#SetLocationBtn').click(event => {
        var btn = $(event.currentTarget)
        var lat = btn.attr("lat");
        var lng = btn.attr("lng");
        var case_id = btn.attr("case_id");
        if (lat && lng) {
            $("#ShowOnMap_" + case_id).attr({
                lat: lat,
                lng: lng,
                'data-bs-toggle': ''
            })
            //make ajax call to save location to database
            ajaxCall('location/case/set', 'POST', { case_id: case_id, lat: parseFloat(lat), lng: parseFloat(lng), csrfmiddlewaretoken: getCookie('csrftoken') }, (response) => {
                if (response.status != 'OK') {
                    alert('Error while saving location on server')
                }
            })
        } else {
            event.preventDefault();
            alert("You need to set the location first")
        }
    })
}


/*
Add a click event listener on the button which gets the lat and lng attribute
from the button and if the exists then center the map at that location and 
adds a marker. If the attributes don't exists then make ajax call to server and 
see if they exists there then center map nd add marker to that position
else proceed for a user promt to set hte location
*/

$("button[id^='ShowOnMap']").click(function (e) {
    const button = $(e.currentTarget);
    const case_id = button.attr("case_id");
    var lat = button.attr("lat");
    var lng = button.attr("lng");
    var address = button.attr("address");

    if (lat && lng) {
        MainMap.setCenter({ lat: parseFloat(lat), lng: parseFloat(lng) })
        if (IncidentMarker) IncidentMarker.setMap(null)
        IncidentMarker = new google.maps.Marker({
            position: { lat: parseFloat(lat), lng: parseFloat(lng) },
            map: MainMap,
            //label: place[0],
            title: "Incident Location",
        });
        e.preventDefault()
    } else {

        // ajax get call to get location else prompt supervisor
        // to select the location from the map
        ajaxCall('location/case/get', 'GET', { case_id: case_id }, (response) => {
            let caseLocation;
            if (response.status == 'OK') {
                caseLocation = response.location;
                if (caseLocation.lat != 'null') {
                    e.preventDefault()
                    caseLocation = { lat: parseFloat(caseLocation.lat), lng: parseFloat(caseLocation.lng) }
                    MainMap.setCenter(caseLocation);
                    button.attr(caseLocation);
                } else {
                    buildSetLocationMap(case_id, address);
                }
            } else {
                buildSetLocationMap(case_id, address);
            }
        })
    }

})

function getCookie(key) {
    var cookies = document.cookie;
    var value = cookies.split(key + '=');
    if (value.length > 1) {
        return value[1].split(';')[0]

    }
}

window.initMap = initMap;
